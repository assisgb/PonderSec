{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PonderSEC — Perguntar</title>

    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "Space Grotesk", system-ui, sans-serif;
            background: radial-gradient(circle at top, #051015 0, #02060b 45%, #000000 100%);
            color: #e5fef6;
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        .background-grid {
            position: fixed; inset: 0;
            background-image: linear-gradient(90deg, rgba(0, 255, 160, 0.06) 1px, transparent 1px), linear-gradient(180deg, rgba(0, 255, 160, 0.06) 1px, transparent 1px);
            background-size: 40px 40px; opacity: 0.4; pointer-events: none;
        }
        .glow-orb {
            position: fixed; width: 400px; height: 400px; border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 255, 160, 0.3), transparent 65%);
            top: 10%; right: 10%; filter: blur(18px); opacity: 0.75; pointer-events: none;
        }

        .container {
            position: relative; width: 100%; max-width: 720px;
            background: radial-gradient(circle at top, #0b141d 0, #050a11 55%, #020509 100%);
            border-radius: 18px; padding: 36px;
            box-shadow: 0 0 0 1px rgba(0, 255, 160, 0.25), 0 18px 60px rgba(0, 0, 0, 0.9);
            z-index: 2; max-height: 95vh; overflow-y: auto;
        }

        .product-name { text-align: center; color: #7df6c2; text-transform: uppercase; letter-spacing: 0.28em; font-size: 13px; margin: 10px 0 4px 0; }
        .headline { text-align: center; color: #00ff9f; font-size: 26px; font-weight: 700; margin-bottom: 6px; }
        .subtitle { text-align: center; font-size: 14px; color: #8ba1b0; margin-bottom: 25px; }

        label { font-size: 13px; color: #a7bbc8; margin-bottom: 6px; display: block; }
        textarea {
            width: 100%; min-height: 120px; resize: vertical; padding: 15px;
            border: 1px solid #1b2635; background: #050a11; color: #e5fef6;
            border-radius: 10px; font-size: 15px; outline: none; transition: all 0.2s; margin-bottom: 16px;
            font-family: "Space Grotesk", sans-serif;
        }
        textarea:focus { border-color: #00ff9f; box-shadow: 0 0 14px rgba(0, 255, 160, 0.4); }

        .btn-back {
            display: inline-block; padding: 8px 20px;
            background: #00ff9f; color: #000; text-decoration: none;
            border-radius: 20px; font-weight: bold; font-size: 12px;
            margin-bottom: 20px; text-transform: uppercase;
        }
        
        .button-primary {
            width: 100%; padding: 16px;
            background: #00ff9f;
            border: none; border-radius: 999px; cursor: pointer;
            font-size: 16px; font-weight: 800; color: #020509;
            letter-spacing: 0.05em; text-transform: uppercase; transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 255, 159, 0.3);
        }
        .button-primary:hover {
            background: #00e68e; transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 159, 0.5);
        }
        .button-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .response-box-gemini, .response-box-groq {
            margin-top: 22px; padding: 20px; border-radius: 14px;
            background: rgba(5, 16, 21, 0.6);
            border: 1px solid #1b2635;
            min-height: 140px; max-height: 500px;
            overflow-y: auto; color: #dffef2; font-size: 15px; line-height: 1.6; white-space: pre-wrap;
            position: relative;
        }

        .response-box-gemini { border-left: 3px solid #00ff9f; }
        .response-box-groq { border-left: 3px solid #7df6c2; }

        .response-placeholder { color: #4a5a6a; font-style: italic; opacity: 0.7; }

        .typing-cursor::after {
            content: '▋'; display: inline-block; vertical-align: bottom;
            color: #00ff9f; animation: blink 1s step-end infinite; margin-left: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .mermaid { background: #0b141d; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; }
        
        .hidden-source {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: pre-wrap; /* Mantém as quebras de linha importantes! */
            border: 0;
            opacity: 0; /* Totalmente transparente */
        }
        
        .logo-container { text-align: center; margin-bottom: 10px; }
        .logo-img { width: 80px; border-radius: 10px; }
    </style>
</head>

<body>

<div class="background-grid"></div>
<div class="glow-orb"></div>

<div class="container">
    <a href="{% url 'pondersecoptions' %}" class="btn-back">Voltar</a>
    
    <div class="logo-container">
        <div class="product-name">PONDERSEC</div>
    </div>
    
    <div class="headline">Pergunte à LLM</div>
    <div class="subtitle">Digite sua pergunta e aguarde a resposta do sistema</div>

    <form method="POST" action="{% url 'perguntar' %}" onsubmit="travarBotao()">
        {% csrf_token %}
        <label for="pergunta">Pergunta</label>
        <textarea id="pergunta" name="pergunta" placeholder="Ex: Explique como explorar uma vulnerabilidade de SQL Injection..." required></textarea>
        
        <button type="submit" id="btnEnviar" class="button-primary">ENVIAR PERGUNTA</button>
    </form>

    <div class="hidden-source" id="gemini-raw">{% if resposta_gemini %}{{ resposta_gemini }}{% endif %}</div>
    
    <div class="response-box-gemini" id="gemini-display">
        {% if not resposta_gemini %}
            <span class="response-placeholder">A resposta da LLM Gemini aparecerá aqui...</span>
        {% endif %}
    </div>

    <div class="hidden-source" id="groq-raw">{% if resposta_groq %}{{ resposta_groq }}{% endif %}</div>

    <div class="response-box-groq" id="groq-display">
        {% if not resposta_groq %}
            <span class="response-placeholder">A resposta da LLM Groq aparecerá aqui...</span>
        {% endif %}
    </div>
</div>

<script>

    function travarBotao() {
        const btn = document.getElementById('btnEnviar');
        const text = document.getElementById('pergunta');
        if(text.value.trim() !== "") {
            btn.disabled = true;
            btn.innerText = 'PROCESSANDO...';
            btn.style.opacity = "0.7";
            btn.style.cursor = "wait";
        }
    }

    mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });

    async function digitarTexto(sourceId, displayId) {
        const sourceElement = document.getElementById(sourceId);
        const displayElement = document.getElementById(displayId);

        console.log(`Lendo fonte: ${sourceId}`);
        
        const rawText = sourceElement ? sourceElement.textContent : "";
        
        console.log(`Texto encontrado (${rawText.length} chars):`, rawText.substring(0, 20) + "...");

        if (!rawText || rawText.trim().length === 0) return;

        displayElement.innerHTML = ""; 
        displayElement.classList.add('typing-cursor');

        const delay = 3; 
        
        for (let i = 0; i < rawText.length; i++) {
            if (rawText[i] === '\n') {
                displayElement.innerHTML += '<br>';
            } else {
                displayElement.append(rawText[i]);
            }
            
            displayElement.scrollTop = displayElement.scrollHeight;

            if (i % 5 === 0) await new Promise(r => setTimeout(r, delay));
        }

        displayElement.classList.remove('typing-cursor');

        renderizarDiagramas(displayId);
    }

    function renderizarDiagramas(elementId) {
        const container = document.getElementById(elementId);
        if (!container) return;

        let content = container.innerHTML;
        const regex = /```mermaid([\s\S]*?)```/g;

        const newContent = content.replace(regex, (match, code) => {
            let cleanCode = code.replace(/<br>/g, '\n').replace(/&gt;/g, '>').replace(/&lt;/g, '<').trim();
            return `<div class="mermaid">${cleanCode}</div>`;
        });

        if (content !== newContent) {
            container.innerHTML = newContent;
            mermaid.init(undefined, container.querySelectorAll('.mermaid'));
        }
    }

    window.addEventListener('load', () => {
        digitarTexto('gemini-raw', 'gemini-display');
        digitarTexto('groq-raw', 'groq-display');
    });
</script>

</body>
</html>